C51 COMPILER V8.08   KEYBOARD                                                              05/30/2017 15:32:59 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE KEYBOARD
OBJECT MODULE PLACED IN ..\output\keyboard.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\source\keyboard.c BROWSE DEBUG OBJECTEXTEND PRINT(.\keyboard.lst) OBJECT
                    -(..\output\keyboard.obj)

line level    source

   1          #define _KEYBOARD_C
   2          #include "config.h"
   3          #include "keyboard.h"
   4          #include "time.h"
   5          
   6          bit flag200ms = 0;
   7          bit flag1s = 0;
   8          bit flag5s = 0;
   9          
  10          uint8 T0RH = 0;
  11          uint8 T0RL = 0;
  12          
  13          uint8 pdata keySta[4][4]={
  14                  {1,1,1,1},{1,1,1,1},{1,1,1,1},{1,1,1,1}
  15          };
  16          
  17          uint8 code keyCodeMap[4][4] = { //矩阵按键编号到标准键盘键码的映射表
  18              { 0x31, 0x32, 0x33, 0x26 }, //数字键1、数字键2、数字键3、向上键
  19              { 0x34, 0x35, 0x36, 0x25 }, //数字键4、数字键5、数字键6、向左键
  20              { 0x37, 0x38, 0x39, 0x28 }, //数字键7、数字键8、数字键9、向下键
  21              { 0x30, 0x1B, 0x0D, 0x27 }  //数字键0、ESC键、  回车键、 向右键
  22          };
  23          
  24          void ClearTremble()
  25          {
  26   1              uint8 i;
  27   1              static uint8 queue = 0; 
  28   1      
  29   1              static uint8 pdata state[4][4] = 
  30   1              {
  31   1                      {0x0F,0x0F,0x0F,0x0F},
  32   1                      {0x0F,0x0F,0x0F,0x0F},
  33   1                      {0x0F,0x0F,0x0F,0x0F},
  34   1                      {0x0F,0x0F,0x0F,0x0F}
  35   1              };
  36   1      
  37   1              switch(queue)
  38   1              {
  39   2                      case 0:KeyOut4 = 1;KeyOut1 = 0;break;
  40   2                      case 1:KeyOut1 = 1;KeyOut2 = 0;break;
  41   2                      case 2:KeyOut2 = 1;KeyOut3 = 0;break;
  42   2                      case 3:KeyOut3 = 1;KeyOut4 = 0;break;
  43   2                      default:break;
  44   2              }
  45   1      
  46   1              state[queue][0] = (state[queue][0] << 1) | KeyIn1;
  47   1              state[queue][1] = (state[queue][1] << 1) | KeyIn2;
  48   1              state[queue][2] = (state[queue][2] << 1) | KeyIn3;
  49   1              state[queue][3] = (state[queue][3] << 1) | KeyIn4;
  50   1      
  51   1              for(i = 0; i < 4; i++)
  52   1              {
  53   2                      if((state[queue][i] & 0x0F) == 0x0F)
  54   2                      {
C51 COMPILER V8.08   KEYBOARD                                                              05/30/2017 15:32:59 PAGE 2   

  55   3                              keySta[queue][i] = 1; 
  56   3                      }else if((state[queue][i] & 0x0F) == 0x00){
  57   3                              keySta[queue][i] = 0;
  58   3                      }else{
  59   3                      }
  60   2              }
  61   1      
  62   1              queue++;
  63   1              queue &= 0x03;
  64   1      }
  65          
  66          void KeyDriver()
  67          {
  68   1              static uint8 pdata keyBuf[4][4]={
  69   1                      {1,1,1,1},{1,1,1,1},{1,1,1,1},{1,1,1,1} 
  70   1              };
  71   1              uint8 i,j;
  72   1      
  73   1              for(i = 0; i < 4; i++)
  74   1              {
  75   2                      for(j = 0; j < 4; j++)
  76   2                      {
  77   3                              if(keyBuf[i][j] != keySta[i][j])
  78   3                              {
  79   4                                      if(keyBuf[i][j] == 0x00)
  80   4                                      {
  81   5                                              KeyAction(keyCodeMap[i][j]);
  82   5                                      }
  83   4                                      keyBuf[i][j] = keySta[i][j];
  84   4                              }
  85   3                      }
  86   2              }       
  87   1      }
  88          
  89          void ConfigTimerZero(uint8 ms)
  90          {
  91   1              uint16 tmp;
  92   1      
  93   1              tmp = 65536 - SYS_CLK/1000*ms + 18;
  94   1      
  95   1              T0RH = (uint8)(tmp >> 8);
  96   1              T0RL = (uint8)(tmp & 0x0F);
  97   1      
  98   1              TMOD &= 0xF0;
  99   1              TMOD |= 0x01;
 100   1      
 101   1              TH0 = T0RH;
 102   1              TL0 = T0RL;
 103   1      
 104   1              TR0 = 1;
 105   1              ET0 = 1;
 106   1      }
 107          
 108          void InterruptTimerZero() interrupt 1
 109          {
 110   1              static uint8 cnt200ms = 0, cnt1s = 0, cnt5s = 0;
 111   1      
 112   1              TH0 = T0RH;
 113   1              TL0 = T0RL;
 114   1      
 115   1              cnt200ms++;                     
 116   1              if(cnt200ms >= 200) //200ms定时器
C51 COMPILER V8.08   KEYBOARD                                                              05/30/2017 15:32:59 PAGE 3   

 117   1              {
 118   2                      cnt200ms = 0;
 119   2                      flag200ms = 1;
 120   2                      cnt1s++;                //1s定时器
 121   2                      if(cnt1s >= 5)
 122   2                      {
 123   3                              cnt1s = 0;
 124   3                              flag1s = 1;
 125   3                      }
 126   2                      cnt5s++;
 127   2                      if(cnt5s >= 25)
 128   2                      {
 129   3                              cnt5s = 0;
 130   3                              flag5s = 1;
 131   3                      }
 132   2              }
 133   1              ClearTremble();
 134   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    449    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     48    ----
   DATA SIZE        =      6       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
